<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thank You!</title>

<link rel="stylesheet" href="styles.css">

<!-- SMTP.js -->
<script src="https://smtpjs.com/v3/smtp.js"></script>
</head>

<body>

<div class="container">
    <h1>Thank You for Participating!</h1>
    <p>We appreciate you taking the time to complete the quiz.</p>
    <p>Your results are being processed and will be emailed shortly.</p>

    <p id="emailStatus"></p>
</div>

<script>

/* ================= CONFIG ================= */

const SMTP_SECURE_TOKEN = "gkmk wdni nkpm mgul";
const ADMIN_EMAIL = "alexis.d.commodore@mass.gov";
const DELAY_MS = 24 * 60 * 60 * 1000;

/* ================= CSV EXPORT ================= */

function makeResultsCSV(rows) {
    if (!rows.length) return "";

    const headers = Object.keys(rows[0]);
    const escape = v => `"${String(v ?? "").replace(/"/g, '""')}"`;

    const lines = [headers.join(",")];

    rows.forEach(row => {
        lines.push(headers.map(h => escape(row[h])).join(","));
    });

    return lines.join("\n");
}

function downloadResultsFile(csvText) {
    if (!csvText) return "";

    const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
    const filename = `forensic-iat-results-${timestamp}.csv`;

    const blob = new Blob([csvText], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const link = document.createElement("a");
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();

    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    return filename;
}

/* ================= BIAS ANALYSIS ================= */

function summarizeBias(results) {
    const counts = { none: 0, slight: 0, strong: 0 };

    function summarize(field) {
        const map = {};

        results.forEach(r => {
            if (r.bias_level === "none") return;
            const key = r[field] || "Unspecified";
            map[key] = (map[key] || 0) + 1;
        });

        return Object.entries(map)
            .sort((a, b) => b[1] - a[1])
            .map(([k, v]) => `${k} (${v})`)
            .join(", ") || "None observed";
    }

    results.forEach(r => counts[r.bias_level]++);

    return {
        none_count: counts.none,
        slight_count: counts.slight,
        strong_count: counts.strong,
        bias_by_age_summary: summarize("age"),
        bias_by_race_summary: summarize("race"),
        bias_by_gender_summary: summarize("gender"),
        bias_by_context_summary: summarize("scenario_context"),
        bias_by_assault_type_summary: summarize("assault_type")
    };
}

function averageReactionTime(results) {
    if (!results.length) return 0;
    const sum = results.reduce((a, r) => a + Number(r.reaction_time_sec || 0), 0);
    return (sum / results.length).toFixed(2);
}

/* ================= EMAIL BODY ================= */

function buildEmailBody(results, totalTimeSec) {
    const bias = summarizeBias(results);
    const avgRT = averageReactionTime(results);

    return `
Hello,

Thank you for completing the Patient Scenarios quiz.

Overall Participation Summary:
Total scenarios: ${results.length}
Average response time: ${avgRT} seconds
Total quiz time: ${totalTimeSec} seconds

Bias Classification Overview:
No Bias Detected: ${bias.none_count}
Slight Bias Indicators: ${bias.slight_count}
Strong Bias Indicators: ${bias.strong_count}

Bias observed in categories:
Age groups: ${bias.bias_by_age_summary}
Race/Ethnicity: ${bias.bias_by_race_summary}
Gender: ${bias.bias_by_gender_summary}
Scenario context: ${bias.bias_by_context_summary}
Assault type: ${bias.bias_by_assault_type_summary}

These results are intended to support reflection and continued growth in equitable, trauma-informed care.

Thank you again for your participation.

Best regards,
Program Team
`;
}

/* ================= EMAIL SEND ================= */

async function sendEmail(to, subject, body) {
    return Email.send({
        SecureToken: SMTP_SECURE_TOKEN,
        To: to,
        From: ADMIN_EMAIL,
        Subject: subject,
        Body: body.replace(/\n/g, "<br>")
    });
}

/* ================= MAIN FLOW ================= */

window.addEventListener("load", async () => {
    const statusEl = document.getElementById("emailStatus");

    const participantEmail =
        sessionStorage.getItem("quizEmail") || "";

    const results =
        JSON.parse(sessionStorage.getItem("quizResults") || "[]");

    const totalTimeSec =
        sessionStorage.getItem("quizTotalTimeSec") || "";

    if (!participantEmail || !results.length) {
        statusEl.textContent =
            "Missing quiz data. Please retake the quiz.";
        return;
    }

    const csvText = makeResultsCSV(results);
    const filename = downloadResultsFile(csvText);

    const emailBody = buildEmailBody(results, totalTimeSec);

    try {
        /* Immediate admin email */
        await sendEmail(
            ADMIN_EMAIL,
            "Quiz Results (Admin Copy)",
            emailBody
        );

        /* Delayed participant email */
        setTimeout(async () => {
            await sendEmail(
                participantEmail,
                "Your Patient Scenario Results",
                emailBody
            );
        }, DELAY_MS);

        statusEl.textContent =
            `Results saved (${filename}). Emails scheduled.`;

    } catch (err) {
        console.error(err);
        statusEl.textContent =
            "Results saved, but email failed.";
    }
});
</script>

</body>
</html>
