<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thank You!</title>

<link rel="stylesheet" href="styles.css">

<!-- EmailJS v4 per docs -->
<script type="module">
  import emailjs from "https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js";
  window.emailjs = emailjs;
</script>

</head>

<body>

<div class="container">
    <h1>Thank You for Participating!</h1>
    <p>We appreciate you taking the time to complete the quiz.</p>
    <p>Your results are being processed. Check this page for status messages.</p>

    <p id="emailStatus"></p>
</div>

<script>
/* ================= CONFIG ================= */
const EMAILJS_PUBLIC_KEY = "htplD2J6SNIDYdyuK";
const EMAILJS_SERVICE_ID = "service_gexzh1q";
const EMAILJS_TEMPLATE_ID = "template_qi850zs";
const ADMIN_EMAIL = "alexis.d.commodore@mass.gov";
const DELAY_MS = 24 * 60 * 60 * 1000; // 24 hours

/* ================= CSV EXPORT ================= */
function makeResultsCSV(rows) {
    if (!rows.length) return "";
    const headers = Object.keys(rows[0]);
    const escape = v => `"${String(v ?? "").replace(/"/g, '""')}"`;
    const lines = [ headers.join(",") ];
    rows.forEach(r => {
        lines.push(headers.map(h => escape(r[h])).join(","));
    });
    return lines.join("\n");
}

function downloadResultsFile(csvText) {
    if (!csvText) return "";
    const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
    const filename = `forensic-iat-results-${timestamp}.csv`;
    const blob = new Blob([csvText], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    return filename;
}

/* ================= BIAS ANALYSIS ================= */
function summarizeBias(results) {
    const counts = { none: 0, slight: 0, strong: 0 };
    function summarize(field) {
        const map = {};
        results.forEach(r => {
            if (r.bias_level === "none") return;
            const key = r[field] || "Unspecified";
            map[key] = (map[key] || 0) + 1;
        });
        return Object.entries(map)
            .sort((a,b) => b[1] - a[1])
            .map(([k,v]) => `${k} (${v})`)
            .join(", ") || "None observed";
    }
    results.forEach(r => counts[r.bias_level]++);
    return {
        none_count: counts.none,
        slight_count: counts.slight,
        strong_count: counts.strong,
        bias_by_age_summary: summarize("age"),
        bias_by_race_summary: summarize("race"),
        bias_by_gender_summary: summarize("gender"),
        bias_by_context_summary: summarize("scenario_context"),
        bias_by_assault_type_summary: summarize("assault_type")
    };
}

function averageReactionTime(results) {
    if (!results.length) return 0;
    const sum = results.reduce((a,r) => a + Number(r.reaction_time_sec || 0), 0);
    return (sum / results.length).toFixed(2);
}

/* ================= EMAIL SEND ================= */
async function sendResultsEmail({ toEmail, csvText, totalTimeSec, label }) {
    const parsedResults = JSON.parse(sessionStorage.getItem("quizResults") || "[]");
    const biasSummary = summarizeBias(parsedResults);
    const avgRT = averageReactionTime(parsedResults);

    return emailjs.send(
        EMAILJS_SERVICE_ID,
        EMAILJS_TEMPLATE_ID,
        {
            to_email: toEmail,
            send_type: label,
            total_questions: parsedResults.length,
            total_quiz_time: totalTimeSec,
            average_response_time: avgRT,
            results_csv: csvText,

            none_count: biasSummary.none_count,
            slight_count: biasSummary.slight_count,
            strong_count: biasSummary.strong_count,
            bias_by_age_summary: biasSummary.bias_by_age_summary,
            bias_by_race_summary: biasSummary.bias_by_race_summary,
            bias_by_gender_summary: biasSummary.bias_by_gender_summary,
            bias_by_context_summary: biasSummary.bias_by_context_summary,
            bias_by_assault_type_summary: biasSummary.bias_by_assault_type_summary
        }
    );
}

/* ================= MAIN FLOW ================= */
window.addEventListener("load", async () => {
    const statusEl = document.getElementById("emailStatus");

    const participantEmail = sessionStorage.getItem("quizEmail") || "";
    const results = JSON.parse(sessionStorage.getItem("quizResults") || "[]");
    const totalTimeSec = sessionStorage.getItem("quizTotalTimeSec") || "";

    if (!participantEmail || !results.length) {
        statusEl.textContent = "Missing quiz data. Please retake the quiz.";
        return;
    }

    const csvText = makeResultsCSV(results);
    const filename = downloadResultsFile(csvText);

    try {
        /* Initialize EmailJS */
        emailjs.init(EMAILJS_PUBLIC_KEY);

        /* Admin email */
        await sendResultsEmail({
            toEmail: ADMIN_EMAIL,
            csvText,
            totalTimeSec,
            label: "Immediate (Admin)"
        });

        /* Delayed participant email */
        setTimeout(async () => {
            try {
                await sendResultsEmail({
                    toEmail: participantEmail,
                    csvText,
                    totalTimeSec,
                    label: "Delayed (Participant)"
                });
            } catch (err) {
                console.error("Participant email failed:", err);
            }
        }, DELAY_MS);

        statusEl.textContent = `Downloaded (${filename}). Emails scheduled.`;

    } catch (err) {
        console.error(err);
        statusEl.textContent = `Results downloaded, but email failed.`;
    }
});
</script>

</body>
</html>
